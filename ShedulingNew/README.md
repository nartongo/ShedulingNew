# 纺织厂断头接头调度系统

## 项目概述

本项目是一个针对纺织厂的自动化调度系统，主要负责协调AGV（自动导引车）、PLC（可编程逻辑控制器）和机器人，实现对纺织生产线上的断头问题进行自动化修复。系统采用上位机调度模式，通过与各种设备的通信，实现断头信息的采集、AGV的路径规划、机器人的动作控制等功能。

## 系统架构

系统采用三层协调架构：

1. **系统协调层（SystemCoordinator）**：顶层控制，负责初始化和管理其他协调器，处理全局异常
2. **通信协调层（CommunicationCoordinator）**：负责与外部设备（AGV、PLC、后端系统）的通信
3. **工作流协调层（WorkflowCoordinator）**：负责业务流程处理，如任务分配、状态管理等

系统内部各组件通过EventHub事件总线进行松耦合通信，避免复杂的依赖注入结构。

## 系统工作流程

### 断头修复整体流程

系统的核心工作流程遵循以下状态机过程：

1. **接收任务**：从后端系统接收需要维修的细纱机信息（仅机器ID）
2. **派遣AGV**：系统指令AGV前往该细纱机的权限切换点
3. **获取断头数据**：AGV到达切换点后，从MySQL数据库中查询该细纱机的断头数据
4. **本地缓存**：将断头数据缓存到SQLite数据库中，以便离线使用
5. **控制PLC**：通知PLC系统开始处理断头
6. **锭子处理**：顺序处理每个断头锭子，包括：
   - 发送锭位距离到PLC
   - 等待PLC到达锭位
   - 触发接头机构（如皮辊）
   - 确认修复完成
   - 更新数据状态至MySQL
   - 重新查询MySQL获取最新断头信息
   - 更新本地SQLite缓存，确保处理最新的断头数据
7. **任务结束**：处理完所有断头后，返回等待位置

### 数据流向

1. **数据采集流**：
   - 细纱机信息 → 后端系统 → 上位机
   - 断头详细数据 → MySQL数据库 → 上位机 → SQLite缓存
   - 设备状态数据 → PLC/AGV → 上位机 → 状态表缓存 → 后端系统

2. **控制指令流**：
   - 上位机 → AGV指令（前往切换点、返回等待点等）
   - 上位机 → PLC指令（锭子距离、启动皮辊等）

3. **状态反馈流**：
   - AGV状态 → 上位机 → 状态表 → UI展示/后端上报
   - PLC状态 → 上位机 → 处理逻辑/UI展示

## 已实现的核心功能

### 1. 基础架构
- 三层协调器架构
- EventHub事件通信机制
- SQLite本地数据存储

### 2. 设备通信

#### AGV通信服务 (AGVService)
- **UDP通信实现**：
  - 目标IP：192.168.100.178
  - 端口：17804
  - 基于UDP协议的可靠通信实现
  
- **移动控制功能**：
  - 简单导航命令（仅指定目标点）
  - 完整导航命令（指定路径点和路径段）
  - 支持订单ID和任务KEY的任务跟踪

- **状态监控功能**：
  - 实时位置和朝向监控（X, Y, Heading）
  - 运动状态监控（Vx, Vy, Omega）
  - 电池状态监控（电量百分比、电压、电流、充电状态）
  - 状态数据自动发布到事件总线

- **通信协议实现**：
  - 标准28字节报文头
  - 支持0xAE（导航任务）和0xAF（状态查询）命令
  - 通信序列号管理
  - 完整的错误处理和重试机制

#### PLC通信服务 (PLCService)
- 基于ModbusTCP协议
- 支持M和D地址的读写操作
- 实现了断头修复相关的所有信号处理

### 3. 业务处理
- 任务控制器 (TaskController)
- 任务数据管理 (TaskDataManager)

### 4. 数据存储
- SQLite本地缓存
- 机器人状态表

### 5. 用户界面
- 任务监控界面
- PLC数据监控界面
- 机器人状态监控界面

## 最新进展

### AGV通信模块优化

1. **通信可靠性提升**：
   - 实现了UDP通信的可靠性机制
   - 添加了通信序列号管理
   - 完善了错误处理和重试逻辑

2. **状态监控增强**：
   - 新增AgvStatus类，完整封装AGV状态信息
   - 实现了1秒间隔的状态轮询机制
   - 状态变更自动发布到事件总线

3. **移动控制完善**：
   - 支持简单导航和完整路径导航两种模式
   - 导航命令支持订单跟踪
   - 事件通知机制完善

### 机器人状态管理

1. **数据库表设计**：
   - `robot_status_log` - 历史状态日志表
   - `robot_latest_status` - 实时状态缓存表

2. **核心服务**：
   - `RobotStatusService` - 状态管理服务

3. **界面展示**：
   - `RobotStatusView` - 状态监控界面
   - `RobotStatusViewModel` - 界面数据模型

## 设计决策说明

### 1. 为什么采用三层协调架构？
这种架构在复杂系统中提供了良好的关注点分离。系统协调器管理全局状态，通信协调器处理外部交互，工作流协调器处理业务逻辑。这种分离使代码更易于维护和扩展。

### 2. 为什么使用EventHub而不是直接依赖注入？
EventHub提供了一种松耦合的通信方式，避免了组件之间的直接依赖。这在异步操作较多的系统中非常有用，也简化了组件间的交互模式。

### 3. 为什么需要本地SQLite数据库？
- **断网恢复**：当网络中断时，系统可以继续工作
- **数据缓存**：减少对后端系统的频繁请求
- **状态保持**：在系统重启后能够恢复到之前的状态
- **历史追溯**：提供历史数据查询和问题分析能力

### 4. 为什么AGV通信采用UDP协议？
- **实时性要求**：UDP协议的低延迟特性适合实时控制场景
- **状态查询需求**：定期的状态查询不需要建立持久连接
- **简单可靠**：通过应用层实现的确认机制提供了足够的可靠性
- **资源占用低**：相比TCP，UDP的资源占用更少

## 下一步计划

1. **通信协议优化**：
   - 实现AGV通信的断线重连机制
   - 添加通信数据的校验和重传机制
   - 优化PLC通信的性能和稳定性

2. **任务调度优化**：
   - 实现更智能的任务分配算法
   - 优化路径规划策略
   - 添加任务优先级管理

3. **用户界面增强**：
   - 添加AGV实时位置可视化
   - 完善状态监控界面
   - 优化操作交互体验

4. **数据分析功能**：
   - 添加运行数据统计
   - 实现性能分析报表
   - 支持历史数据回放

5. **系统监控与告警**：
   - 实现设备状态监控
   - 添加关键事件告警
   - 支持远程故障诊断

6. **后端通信完善**：
   - 实现状态数据定期上报
   - 支持远程控制指令
   - 优化数据同步机制

## 技术栈

- 开发语言：C# (.NET 8.0)
- 界面框架：WPF
- 数据存储：SQLite + Dapper
- 通信协议：
  - ModbusTCP (PLC通信)
  - UDP (AGV通信)
- 依赖项：
  - System.Data.SQLite.Core
  - Dapper
  - EasyModbusTCP
  - MySql.Data 
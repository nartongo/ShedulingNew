# 纺织厂断头接头调度系统

## 项目概述

本项目是一个针对纺织厂的自动化调度系统，主要负责协调AGV（自动导引车）、PLC（可编程逻辑控制器）和机器人，实现对纺织生产线上的断头问题进行自动化修复。系统采用上位机调度模式，通过与各种设备的通信，实现断头信息的采集、AGV的路径规划、机器人的动作控制等功能。

## 系统架构

系统采用三层协调架构：

1. **系统协调层（SystemCoordinator）**：顶层控制，负责初始化和管理其他协调器，处理全局异常
2. **通信协调层（CommunicationCoordinator）**：负责与外部设备（AGV、PLC、后端系统）的通信
3. **工作流协调层（WorkflowCoordinator）**：负责业务流程处理，如任务分配、状态管理等

系统内部各组件通过EventHub事件总线进行松耦合通信，避免复杂的依赖注入结构。

## 系统工作流程

### 断头修复整体流程

系统的核心工作流程遵循以下状态机过程：

1. **接收任务**：从后端系统接收需要维修的细纱机信息（仅机器ID）
2. **派遣AGV**：系统指令AGV前往该细纱机的权限切换点
3. **获取断头数据**：AGV到达切换点后，从MySQL数据库中查询该细纱机的断头数据
4. **本地缓存**：将断头数据缓存到SQLite数据库中，以便离线使用
5. **控制PLC**：通知PLC系统开始处理断头
6. **锭子处理**：顺序处理每个断头锭子，包括：
   - 发送锭位距离到PLC
   - 等待PLC到达锭位
   - 触发接头机构（如皮辊）
   - 确认修复完成
   - 更新数据状态至MySQL
   - 重新查询MySQL获取最新断头信息
   - 更新本地SQLite缓存，确保处理最新的断头数据
7. **任务结束**：处理完所有断头后，返回等待位置

### 数据流向

1. **数据采集流**：
   - 细纱机信息 → 后端系统 → 上位机
   - 断头详细数据 → MySQL数据库 → 上位机 → SQLite缓存
   - 设备状态数据 → PLC/AGV → 上位机 → 状态表缓存 → 后端系统

2. **控制指令流**：
   - 上位机 → AGV指令（前往切换点、返回等待点等）
   - 上位机 → PLC指令（锭子距离、启动皮辊等）

3. **状态反馈流**：
   - AGV状态 → 上位机 → 状态表 → UI展示/后端上报
   - PLC状态 → 上位机 → 处理逻辑/UI展示

## 已实现的核心功能

### 1. 基础架构
- 三层协调器架构
- EventHub事件通信机制
- SQLite本地数据存储

### 2. 设备通信
- AGV通信服务 (AGVService)
- PLC通信服务 (PLCService) - 基于ModbusTCP协议
- 后端API通信服务

### 3. 业务处理
- 任务控制器 (TaskController) - 处理断头修复任务的状态机
- 任务数据管理 (TaskDataManager) - 处理任务数据的导入导出

### 4. 数据存储
- SQLite本地缓存 - 存储断头数据和任务状态
- 机器人状态表 - 记录和跟踪机器人状态

### 5. 用户界面
- 任务监控界面
- PLC数据监控界面
- 机器人状态监控界面

## 最新进展

### 机器人状态管理

我们最近添加了机器人状态管理功能，包括：

1. **数据库表设计**：
   - `robot_status_log` - 历史状态日志表，记录每次状态变化
   - `robot_latest_status` - 实时状态缓存表，存储最新状态

2. **核心服务**：
   - `RobotStatusService` - 管理机器人状态数据更新、查询和同步

3. **界面展示**：
   - `RobotStatusView` - 显示机器人实时状态和历史记录
   - `RobotStatusViewModel` - 界面数据模型

4. **状态数据来源与流转**：
   - 机器人状态参数（如电量、位置等）主要来源于PLC和AGV通信
   - 这些数据首先在本地SQLite数据库中缓存
   - 系统会将状态数据发送到后端系统（通信方式待确定）
   - 后端系统将这些状态用于全局调度和监控

这种设计实现了"**状态追踪 + 实时恢复机制**"，使系统能够：
- 记录完整状态历史，用于追踪和分析
- 支持断网或断电情况下的状态恢复
- 提供实时状态快照，用于调度决策
- 使UI能够直接展示最新状态
- 确保后端系统能获取正确的设备状态信息，即使连接不稳定

## 设计决策说明

### 1. 为什么采用三层协调架构？
这种架构在复杂系统中提供了良好的关注点分离。系统协调器管理全局状态，通信协调器处理外部交互，工作流协调器处理业务逻辑。这种分离使代码更易于维护和扩展。

### 2. 为什么使用EventHub而不是直接依赖注入？
EventHub提供了一种松耦合的通信方式，避免了组件之间的直接依赖。这在异步操作较多的系统中非常有用，也简化了组件间的交互模式。

### 3. 为什么需要本地SQLite数据库？
- **断网恢复**：当网络中断时，系统可以继续工作
- **数据缓存**：减少对后端系统的频繁请求
- **状态保持**：在系统重启后能够恢复到之前的状态
- **历史追溯**：提供历史数据查询和问题分析能力

### 4. 为什么机器人状态使用两个表？
- **状态日志表** (`robot_status_log`)：完整记录历史变化，支持审计和分析
- **当前状态表** (`robot_latest_status`)：提供快速访问的状态快照，优化读取性能
- **同步状态管理**：`robot_status_log`表中的`sync_status`字段用于跟踪状态记录是否已成功上报到后端
- **失败补偿机制**：当网络恢复后，系统可以查询所有`sync_status=PENDING`的记录并尝试重新发送

## 下一步计划

1. **通信协议优化**：完善与AGV和PLC的通信协议，增加错误处理和重试机制
2. **任务调度优化**：实现更智能的任务分配和路径规划算法
3. **用户界面增强**：添加更多可视化元素，如设备状态图和任务进度展示
4. **数据分析功能**：添加生产数据统计和分析报表
5. **系统监控与告警**：实现系统状态监控和关键事件告警
6. **后端通信完善**：实现与后端系统的稳定通信，支持状态数据上报和远程控制

## 技术栈

- 开发语言：C# (.NET 8.0)
- 界面框架：WPF
- 数据存储：SQLite + Dapper
- 通信协议：ModbusTCP (PLC通信)
- 依赖项：
  - System.Data.SQLite.Core
  - Dapper
  - EasyModbusTCP